(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{wKyo:function(e,t,a){"use strict";a.r(t),a.d(t,"_frontmatter",(function(){return i})),a.d(t,"default",(function(){return s}));a("91GP"),a("rGqo"),a("yt8O"),a("Btvt"),a("RW0V"),a("q1tI");var o=a("7ljp"),n=a("013z");a("qKvR");function r(){return(r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var o in a)Object.prototype.hasOwnProperty.call(a,o)&&(e[o]=a[o])}return e}).apply(this,arguments)}var l,i={},c=(l="PageDescription",function(e){return console.warn("Component "+l+" was not imported, exported, or provided by MDXProvider as global scope"),Object(o.b)("div",e)}),p={_frontmatter:i},b=n.a;function s(e){var t=e.components,a=function(e,t){if(null==e)return{};var a,o,n={},r=Object.keys(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,["components"]);return Object(o.b)(b,r({},p,a,{components:t,mdxType:"MDXLayout"}),Object(o.b)(c,{mdxType:"PageDescription"},Object(o.b)("p",null,"If any known issues exist or migration paths are needed to upgrade from one version of the DataPower Operator to another, they will be documented here.")),Object(o.b)("h1",null,"1.2.0"),Object(o.b)("h2",null,"Slow Kubernetes garbage collection can cause webhook service creation to fail"),Object(o.b)("h3",null,"Symptoms"),Object(o.b)("p",null,"An error may be seen that indicates a webhook ",Object(o.b)("inlineCode",{parentName:"p"},"Service")," is not found:"),Object(o.b)("pre",null,Object(o.b)("code",r({parentName:"pre"},{}),'failed calling webhook "datapowerservices.defaulter.datapower.ibm.com": Post https://datapower-operator.default.svc:443/default-datapower-ibm-com-v1beta2-datapowerservice?timeout=2s: service "datapower-operator" not found\n')),Object(o.b)("p",null,"In the ",Object(o.b)("inlineCode",{parentName:"p"},"datapower-operator")," pod logs, the following log message is seen indicating the ",Object(o.b)("inlineCode",{parentName:"p"},"Service")," exists already:"),Object(o.b)("pre",null,Object(o.b)("code",r({parentName:"pre"},{}),'{"level":"info","ts":"2020-10-06T20:32:45.818Z","logger":"setup-webhook","msg":"webhook service found. skip create"}\n')),Object(o.b)("p",null,"However, checking for the ",Object(o.b)("inlineCode",{parentName:"p"},"Service")," object (name ",Object(o.b)("inlineCode",{parentName:"p"},"datapower-operator"),") in the namespace would show it does not exist:"),Object(o.b)("pre",null,Object(o.b)("code",r({parentName:"pre"},{}),"$ kubectl get svc datapower-operator\n")),Object(o.b)("h3",null,"Description"),Object(o.b)("p",null,"During the DataPower Operator boot the defaulting and validating webhooks are initialized. As part of this process, a ",Object(o.b)("inlineCode",{parentName:"p"},"Service")," object is created if not found in the cluster. If the Kubernetes garbage collection is slow or delayed it is possible for the ",Object(o.b)("inlineCode",{parentName:"p"},"Service")," object to have been marked for deletion, but still exist in the namespace for a span of time. If the new DataPower Operator pod attempts to initialize the new ",Object(o.b)("inlineCode",{parentName:"p"},"Service")," resource during this time window, the operator will continue through the boot sequence without creating a new ",Object(o.b)("inlineCode",{parentName:"p"},"Service")," instance."),Object(o.b)("p",null,"Once the Kubernetes garbage collection catches up, and the ",Object(o.b)("inlineCode",{parentName:"p"},"Service")," is deleted, no ",Object(o.b)("inlineCode",{parentName:"p"},"Service")," will remain to expose the webhooks and thus API errors will be seen when invoking the webhooks."),Object(o.b)("h3",null,"Solution"),Object(o.b)("p",null,"To resolve this issue, the DataPower Operator pod can be deleted manually. Once this is done, the Deployment’s ReplicaSet controller will spin up a new DataPower Operator pod, which will in turn create the webhook ",Object(o.b)("inlineCode",{parentName:"p"},"Service"),"."),Object(o.b)("ol",null,Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Fetch the DataPower Operator pod, taking note of the name (will be the first column in the output)."),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",r({parentName:"pre"},{}),"kubectl [-n namespace] get pod | grep datapower-operator\n"))),Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Delete the DataPower Operator pod, where ",Object(o.b)("inlineCode",{parentName:"p"},"name")," is the name of the pod found in Step 5."),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",r({parentName:"pre"},{}),"kubectl [-n namespace] delete pod/name\n"))),Object(o.b)("li",{parentName:"ol"},Object(o.b)("p",{parentName:"li"},"Validate a new pod is created in its place."),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",r({parentName:"pre"},{}),"kubectl [-n namespace] get pod | grep datapower-operator\n")))),Object(o.b)("h1",null,"1.1.0"),Object(o.b)("h2",null,"Operator lock not released after Leader Pod removed"),Object(o.b)("h3",null,"Symptoms"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Immediately following an upgrade from 1.0.X to 1.1.X, you may see the following error when attempting to interact with a DataPowerService CR:",Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",r({parentName:"pre"},{}),'Error from server: conversion webhook for datapower.ibm.com/v1beta1, Kind=DataPowerService failed: Post https://changeme.default.svc:443/?timeout=30s: service "changeme" not found\n'))),Object(o.b)("li",{parentName:"ul"},"Failure to reconcile changes made to a DataPowerService CR after a failover event caused the previous DataPower Operator Leader Pod to be rescheduled.")),Object(o.b)("h3",null,"Description"),Object(o.b)("p",null,"Occasionally, when the DataPower Operator Leader Pod is removed, the new DataPower Operator Pod will show as being Ready but isn’t doing anything. In the logs you might see"),Object(o.b)("pre",null,Object(o.b)("code",r({parentName:"pre"},{}),'{"level":"info","ts":"2020-09-08T19:29:53.432Z","logger":"leader","msg":"Not the leader. Waiting."}\n{"level":"info","ts":"2020-09-08T19:29:57.971Z","logger":"leader","msg":"Leader pod has been deleted, waiting for garbage collection do remove the lock."}\n')),Object(o.b)("p",null,"followed by additional waiting. In this case, Kubernetes’ garbage collection failed to clean up the ",Object(o.b)("inlineCode",{parentName:"p"},"datapower-operator-lock")," after the old Leader Pod was removed. This stops the new DataPower Operator Pod from completing initialization tasks such as creating the conversion webhook."),Object(o.b)("h3",null,"Solution"),Object(o.b)("p",null,"To resolve this issue, you must manually remove the lock resource. This can be done with"),Object(o.b)("pre",null,Object(o.b)("code",r({parentName:"pre"},{}),"kubectl delete cm datapower-operator-lock\n")),Object(o.b)("p",null,"Once the lock is removed, the new DataPower Operator pod will begin its initialization."),Object(o.b)("h1",null,"1.0.1"),Object(o.b)("h2",null,"Invalid value for ",Object(o.b)("inlineCode",{parentName:"h2"},"spec.selector")),Object(o.b)("p",null,"When attempting to ugprade from ",Object(o.b)("inlineCode",{parentName:"p"},"1.0.0")," to ",Object(o.b)("inlineCode",{parentName:"p"},"1.0.1")," through the Operator Lifecycle Manager, an error will likely be seen that the ",Object(o.b)("inlineCode",{parentName:"p"},"installPlan")," failed."),Object(o.b)("pre",null,Object(o.b)("code",r({parentName:"pre"},{}),'install strategy failed: Deployment.apps "datapower-operator" is invalid: spec.selector: Invalid value: v1.LabelSelector{...}, MatchExpressions:[]v1.LabelSelectorRequirement(nil)}: field is immutable\n')),Object(o.b)("p",null,"This error occurs because between version ",Object(o.b)("inlineCode",{parentName:"p"},"1.0.0")," and ",Object(o.b)("inlineCode",{parentName:"p"},"1.0.1")," a new ",Object(o.b)("inlineCode",{parentName:"p"},"label")," was added to the DataPower Operator Deployment resource to fix an issue related to operator-metrics. However, the install plan is not able to resolve this update because the LabelSelector is an immutable field."),Object(o.b)("h3",null,"Resolution"),Object(o.b)("p",null,"To workaround this issue, you can manually delete the existing ",Object(o.b)("inlineCode",{parentName:"p"},"datapower-operator")," Deployment resource. The Operator Lifecycle Manager should then recreate the ",Object(o.b)("inlineCode",{parentName:"p"},"datapower-operator")," Deployment resource with the ",Object(o.b)("inlineCode",{parentName:"p"},"1.0.1")," spec, and the install plan should succeed."),Object(o.b)("pre",null,Object(o.b)("code",r({parentName:"pre"},{}),"oc delete deployment datapower-operator\n")),Object(o.b)("p",null,"Once done, validate a new ",Object(o.b)("inlineCode",{parentName:"p"},"datapower-operator")," Deployment is created:"),Object(o.b)("pre",null,Object(o.b)("code",r({parentName:"pre"},{}),"oc get deployment\n")),Object(o.b)("p",null,"Then validate the ",Object(o.b)("inlineCode",{parentName:"p"},"1.0.1")," install plan succeeds by checking the ",Object(o.b)("inlineCode",{parentName:"p"},"ClusterServiceVersion")," resource:"),Object(o.b)("pre",null,Object(o.b)("code",r({parentName:"pre"},{}),"$ oc get csv\nNAME                        DISPLAY                 VERSION   REPLACES                    PHASE\ndatapower-operator.v1.0.1   IBM DataPower Gateway   1.0.1     datapower-operator.v1.0.0   Succeeded\n")))}s.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-troubleshooting-operator-upgrades-mdx-b8b5b7d01b4d3a0f30ac.js.map