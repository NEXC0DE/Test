{"componentChunkName":"component---src-pages-guides-v-2018-v-10-migration-mdx","path":"/guides/v2018-v10-migration/","result":{"pageContext":{"frontmatter":{"title":"Migrating from v2018 to v10","description":"Guide for migrating an existing IBM DataPower v2018 deployment to v10"},"relativePagePath":"/guides/v2018-v10-migration.mdx","titleType":"page","MdxNode":{"id":"e29ced39-ecf6-5b18-b355-fdcceb7f3459","children":[],"parent":"e152d848-4c28-5c72-b2cb-d05af64d6405","internal":{"content":"---\ntitle: Migrating from v2018 to v10\ndescription: Guide for migrating an existing IBM DataPower v2018 deployment to v10\n---\n\n<PageDescription>\n\nThis guide provides steps to migrate an existing (Helm based) v2018 IBM DataPower deployment to a v10 IBM DataPower deployment, using the IBM DataPower Operator.\n\n</PageDescription>\n\n<AnchorLinks small>\n  <AnchorLink>Prerequisites</AnchorLink>\n  <AnchorLink>Overview</AnchorLink>\n  <AnchorLink>Step 1: Update v2018 with Migration Labels</AnchorLink>\n  <AnchorLink>Step 2: Deploy v10</AnchorLink>\n  <AnchorLink>Step 3: Edit Services to Select on Migration Labels</AnchorLink>\n  <AnchorLink>Step 4: Scale down v2018; Scale up v10</AnchorLink>\n  <AnchorLink>Step 5: Delete Helm installation</AnchorLink>\n  <AnchorLink>Step 6: Edit Service to Select only v10</AnchorLink>\n  <AnchorLink>Step 7: Remove Migration Labels from v10</AnchorLink>\n</AnchorLinks>\n\n## Prerequisites\n\nThis migration document assumes that a user has all v10 resources ready to deploy. Specifically, it assumes the following prerequistes:\n\n- A v2018 Helm deployment of IBM DataPower\n- An IBM DataPower Operator deployed watching the relevant namespace\n- A functionally equivalent v10 `DataPowerService` Custom Resource\n- All relevant ConfigMaps and Secrets have been created\n\n## Overview\n\n1. Update v2018 Deployment with \"migration labels\"\n2. Create `DataPowerService` Custom Resource in namespace with single replica and \"migration labels\"\n    - If resources are constrained, scale the v2018 deployment down by 1 replica\n3. Edit Service(s) to change Label Selectors to match \"migration labels\"\n4. Scale down v2018 and scale up v10 1 replica at a time\n5. Uninstall Helm deployment\n6. Edit Service(s) to change Label Selectors from \"migration labels\" to v10 labels\n7. Remove \"migration labels\" from v10 StatefulSet\n\n## Step 1: Update v2018 with Migration Labels\n\nTo perform a side-by-side migration from Helm managed v2018 to Operator managed v10, you must bridge the gap with \"migration labels.\" These labels will be used to connect the v2018 and v10 Pods to the same API traffic via the relevant Services while scaling operations are performed. To add the label, you can edit the Deployment or StatefulSet directly:\n\n```\nkubectl edit Deployment v2018-ibm-datapower-dev\n```\n\nWhere `v2018-ibm-datapower-dev` is the name of your v2018 Deployment.\n\nThe labels section of your Deployment yaml should look similar to:\n\n```yaml\nspec:\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/instance: v2018\n        app.kubernetes.io/managed-by: Helm\n        app.kubernetes.io/name: v2018-ibm-datapower-dev\n        helm.sh/chart: ibm-datapower-dev-3.0.5\n        release: v2018\n```\n\nYou will now add a label, `v2018.v10.datapower.migration: <release-name>` where `<release-name>` is the name of this release. This new label will be the intermediary Selector for the Services handling your traffic. The purpose of `<release-name>` is to ensure uniqueness so that your Service doesn't send traffic to another Deployment with an on-going migration. Using the above example labels, your new label set should look like:\n\n```yaml\nspec:\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/instance: v2018\n        app.kubernetes.io/managed-by: Helm\n        app.kubernetes.io/name: v2018-ibm-datapower-dev\n        helm.sh/chart: ibm-datapower-dev-3.0.5\n        release: v2018\n        v2018.v10.datapower.migration: v2018\n```\n\nNow save and exit your editor, which should prompt an update of the v2018 Deployment. This will cause a Rolling Update (default) and you should wait until all pods are back up before proceeding to the next step.\n\n## Step 2: Deploy v10\n\n<InlineNotification>\n\n**Note:** If resources are constrained, first decrease the number of v2018 replicas by 1 and initially configure your DataPowerService yaml to have 1 replica. This will ensure no increase in resource usage.\n\n</InlineNotification>\n\nNow we need to install the v10 StatefulSet. A prerequisite for this guide is to have built a DataPowerService CustomResource yaml that configures the same APIs as your v2018 deployment. Before installing this custom resource, you need to add the \"migration labels\" to it. To do so, add the following to your custom resource yaml:\n\n```yaml\nspec:\n  labels:\n    v2018.v10.datapower.migration: <v2018-release-name>\n```\n\n<InlineNotification>\n\nIt is important to use the v2018 release name as the value for the migration label so the Service can send traffic to both v2018 and v10 Pods.\n\n</InlineNotification>\n\nWith the migration label in place, install the `DataPowerService` resource.\n\n```\nkubectl apply -f datapowerservice.yaml\n```\n\nWait for a minute for the Pods to come up. Once up, you can inspect the labels.\n\n```\nkubectl describe pod <v10-pod>\n```\n\nThe labels on the v10 pod should resemble:\n\n```yaml\nLabels:       app.kubernetes.io/component=datapower\n              app.kubernetes.io/instance=test-v10-datapower\n              app.kubernetes.io/managed-by=datapower-operator\n              app.kubernetes.io/name=datapower\n              app.kubernetes.io/version=10.0.0.0\n              controller-revision-hash=v10-datapower-9fdb8f499\n              v2018.v10.datapower.migration=v2018\n```\n\nNote that now you have a common label on both v2018 and v10 Pods. This allows us to edit any Service objects to send traffic to both sets of Pods.\n\n## Step 3: Edit Services to Select on Migration Labels\n\nWith the labels in place, it's time to edit the relevant service(s) to `Select` using the \"migration label\" instead of previous Selectors.\n\n<InlineNotification>\n\nYou will need to do this for each and every existing `Service` that routes traffic to your v2018 deployment.\n\n</InlineNotification>\n\n```\nkubectl edit Service <v2018-service>\n```\n\nIn your editor, you can find the below `selector` section.\n\n```yaml\nspec:\n  selector:\n    app.kubernetes.io/name: v2018-ibm-datapower-dev\n```\n\nThis selector will need to change to the migration label:\n\n```yaml\nspec:\n  selector:\n    v2018.v10.datapower.migration: v2018\n```\n\n<InlineNotification>\n\nNote: You should remove **all** of the existing labels, such that the `v2018.v10.datapower.migration` is the only remaining selector label.\n\n</InlineNotification>\n\nSave and exit the editor. The Service will now be pointing at both the v2018 and v10 Pods.\n\n## Step 4: Scale down v2018; Scale up v10\n\nWith the traffic handling Service pointing at both v10 and v2018 pods, you can now safely scale down v2018 while scaling up v10.\n\nTo scale down v2018, edit the Deployment/Statefulset and decrease the `spec.replicas` by 1.\n\n```\nkubectl edit Deployment v2018-ibm-datapower-dev\n```\n\nTo scale up v10, edit the DataPowerService resource and increase the `spec.replicas` by 1.\n\n```\nkubectl edit datapowerservice v10-datapower\n```\n\n<InlineNotification>\n\n**Note:** It is important that you edit the `DataPowerService` resource instead of the v10 StatefulSet directly, as the Operator will override the changes you make.\n\n</InlineNotification>\n\nContinue to scale down v2018 and scale up v10 until there are no more v2018 Pods. Between each iteration, wait for the new v10 pod to become `Ready`.\n\n## Step 5: Delete Helm installation (Optional)\n\nIf ability to Rollback isn't required, you can delete the Helm installation at this stage.\n\n```\nhelm delete --purge v2018\n```\n\n## Step 6: Edit Service to Select only v10\n\nWith the v2018 deployment fully scaled down, you can change the Service selectors to be v10 specific.\n\n```\nkubectl edit Service <v2018-service>\n```\n\nYour updated selector labels should look something like:\n\n```yaml\nspec:\n  selector:\n    app.kubernetes.io/name: datapower\n    app.kubernetes.io/instance: test-v10-datapower\n```\n\n## Step 7: Remove Migration Labels from v10 (Optional)\n\nIf desired, clean up the v10 StatefulSet by removing the custom migration label from the Custom Resource.\n\n```\nkubectl edit datapowerservice v10-datapower\n```\n","type":"Mdx","contentDigest":"3eb5c652d0fae21218e2bb136e6b3153","counter":74,"owner":"gatsby-plugin-mdx"},"frontmatter":{"title":"Migrating from v2018 to v10","description":"Guide for migrating an existing IBM DataPower v2018 deployment to v10"},"exports":{},"rawBody":"---\ntitle: Migrating from v2018 to v10\ndescription: Guide for migrating an existing IBM DataPower v2018 deployment to v10\n---\n\n<PageDescription>\n\nThis guide provides steps to migrate an existing (Helm based) v2018 IBM DataPower deployment to a v10 IBM DataPower deployment, using the IBM DataPower Operator.\n\n</PageDescription>\n\n<AnchorLinks small>\n  <AnchorLink>Prerequisites</AnchorLink>\n  <AnchorLink>Overview</AnchorLink>\n  <AnchorLink>Step 1: Update v2018 with Migration Labels</AnchorLink>\n  <AnchorLink>Step 2: Deploy v10</AnchorLink>\n  <AnchorLink>Step 3: Edit Services to Select on Migration Labels</AnchorLink>\n  <AnchorLink>Step 4: Scale down v2018; Scale up v10</AnchorLink>\n  <AnchorLink>Step 5: Delete Helm installation</AnchorLink>\n  <AnchorLink>Step 6: Edit Service to Select only v10</AnchorLink>\n  <AnchorLink>Step 7: Remove Migration Labels from v10</AnchorLink>\n</AnchorLinks>\n\n## Prerequisites\n\nThis migration document assumes that a user has all v10 resources ready to deploy. Specifically, it assumes the following prerequistes:\n\n- A v2018 Helm deployment of IBM DataPower\n- An IBM DataPower Operator deployed watching the relevant namespace\n- A functionally equivalent v10 `DataPowerService` Custom Resource\n- All relevant ConfigMaps and Secrets have been created\n\n## Overview\n\n1. Update v2018 Deployment with \"migration labels\"\n2. Create `DataPowerService` Custom Resource in namespace with single replica and \"migration labels\"\n    - If resources are constrained, scale the v2018 deployment down by 1 replica\n3. Edit Service(s) to change Label Selectors to match \"migration labels\"\n4. Scale down v2018 and scale up v10 1 replica at a time\n5. Uninstall Helm deployment\n6. Edit Service(s) to change Label Selectors from \"migration labels\" to v10 labels\n7. Remove \"migration labels\" from v10 StatefulSet\n\n## Step 1: Update v2018 with Migration Labels\n\nTo perform a side-by-side migration from Helm managed v2018 to Operator managed v10, you must bridge the gap with \"migration labels.\" These labels will be used to connect the v2018 and v10 Pods to the same API traffic via the relevant Services while scaling operations are performed. To add the label, you can edit the Deployment or StatefulSet directly:\n\n```\nkubectl edit Deployment v2018-ibm-datapower-dev\n```\n\nWhere `v2018-ibm-datapower-dev` is the name of your v2018 Deployment.\n\nThe labels section of your Deployment yaml should look similar to:\n\n```yaml\nspec:\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/instance: v2018\n        app.kubernetes.io/managed-by: Helm\n        app.kubernetes.io/name: v2018-ibm-datapower-dev\n        helm.sh/chart: ibm-datapower-dev-3.0.5\n        release: v2018\n```\n\nYou will now add a label, `v2018.v10.datapower.migration: <release-name>` where `<release-name>` is the name of this release. This new label will be the intermediary Selector for the Services handling your traffic. The purpose of `<release-name>` is to ensure uniqueness so that your Service doesn't send traffic to another Deployment with an on-going migration. Using the above example labels, your new label set should look like:\n\n```yaml\nspec:\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/instance: v2018\n        app.kubernetes.io/managed-by: Helm\n        app.kubernetes.io/name: v2018-ibm-datapower-dev\n        helm.sh/chart: ibm-datapower-dev-3.0.5\n        release: v2018\n        v2018.v10.datapower.migration: v2018\n```\n\nNow save and exit your editor, which should prompt an update of the v2018 Deployment. This will cause a Rolling Update (default) and you should wait until all pods are back up before proceeding to the next step.\n\n## Step 2: Deploy v10\n\n<InlineNotification>\n\n**Note:** If resources are constrained, first decrease the number of v2018 replicas by 1 and initially configure your DataPowerService yaml to have 1 replica. This will ensure no increase in resource usage.\n\n</InlineNotification>\n\nNow we need to install the v10 StatefulSet. A prerequisite for this guide is to have built a DataPowerService CustomResource yaml that configures the same APIs as your v2018 deployment. Before installing this custom resource, you need to add the \"migration labels\" to it. To do so, add the following to your custom resource yaml:\n\n```yaml\nspec:\n  labels:\n    v2018.v10.datapower.migration: <v2018-release-name>\n```\n\n<InlineNotification>\n\nIt is important to use the v2018 release name as the value for the migration label so the Service can send traffic to both v2018 and v10 Pods.\n\n</InlineNotification>\n\nWith the migration label in place, install the `DataPowerService` resource.\n\n```\nkubectl apply -f datapowerservice.yaml\n```\n\nWait for a minute for the Pods to come up. Once up, you can inspect the labels.\n\n```\nkubectl describe pod <v10-pod>\n```\n\nThe labels on the v10 pod should resemble:\n\n```yaml\nLabels:       app.kubernetes.io/component=datapower\n              app.kubernetes.io/instance=test-v10-datapower\n              app.kubernetes.io/managed-by=datapower-operator\n              app.kubernetes.io/name=datapower\n              app.kubernetes.io/version=10.0.0.0\n              controller-revision-hash=v10-datapower-9fdb8f499\n              v2018.v10.datapower.migration=v2018\n```\n\nNote that now you have a common label on both v2018 and v10 Pods. This allows us to edit any Service objects to send traffic to both sets of Pods.\n\n## Step 3: Edit Services to Select on Migration Labels\n\nWith the labels in place, it's time to edit the relevant service(s) to `Select` using the \"migration label\" instead of previous Selectors.\n\n<InlineNotification>\n\nYou will need to do this for each and every existing `Service` that routes traffic to your v2018 deployment.\n\n</InlineNotification>\n\n```\nkubectl edit Service <v2018-service>\n```\n\nIn your editor, you can find the below `selector` section.\n\n```yaml\nspec:\n  selector:\n    app.kubernetes.io/name: v2018-ibm-datapower-dev\n```\n\nThis selector will need to change to the migration label:\n\n```yaml\nspec:\n  selector:\n    v2018.v10.datapower.migration: v2018\n```\n\n<InlineNotification>\n\nNote: You should remove **all** of the existing labels, such that the `v2018.v10.datapower.migration` is the only remaining selector label.\n\n</InlineNotification>\n\nSave and exit the editor. The Service will now be pointing at both the v2018 and v10 Pods.\n\n## Step 4: Scale down v2018; Scale up v10\n\nWith the traffic handling Service pointing at both v10 and v2018 pods, you can now safely scale down v2018 while scaling up v10.\n\nTo scale down v2018, edit the Deployment/Statefulset and decrease the `spec.replicas` by 1.\n\n```\nkubectl edit Deployment v2018-ibm-datapower-dev\n```\n\nTo scale up v10, edit the DataPowerService resource and increase the `spec.replicas` by 1.\n\n```\nkubectl edit datapowerservice v10-datapower\n```\n\n<InlineNotification>\n\n**Note:** It is important that you edit the `DataPowerService` resource instead of the v10 StatefulSet directly, as the Operator will override the changes you make.\n\n</InlineNotification>\n\nContinue to scale down v2018 and scale up v10 until there are no more v2018 Pods. Between each iteration, wait for the new v10 pod to become `Ready`.\n\n## Step 5: Delete Helm installation (Optional)\n\nIf ability to Rollback isn't required, you can delete the Helm installation at this stage.\n\n```\nhelm delete --purge v2018\n```\n\n## Step 6: Edit Service to Select only v10\n\nWith the v2018 deployment fully scaled down, you can change the Service selectors to be v10 specific.\n\n```\nkubectl edit Service <v2018-service>\n```\n\nYour updated selector labels should look something like:\n\n```yaml\nspec:\n  selector:\n    app.kubernetes.io/name: datapower\n    app.kubernetes.io/instance: test-v10-datapower\n```\n\n## Step 7: Remove Migration Labels from v10 (Optional)\n\nIf desired, clean up the v10 StatefulSet by removing the custom migration label from the Custom Resource.\n\n```\nkubectl edit datapowerservice v10-datapower\n```\n","fileAbsolutePath":"/home/travis/build/IBM/datapower-operator-doc/src/pages/guides/v2018-v10-migration.mdx"}}}}